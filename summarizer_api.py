# summarizer_api.py
"""
ä½¿ç”¨ SiliconFlow API (DeepSeek V3.2) ç”Ÿæˆæ–‡ç« æ‘˜è¦
"""

import os
import requests
import json
import logging

logger = logging.getLogger(__name__)


PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä½ä¸–ç•Œé¡¶å°–çš„ç”Ÿç‰©åŒ»å­¦ç ”ç©¶ä¸“å®¶ï¼Œä¸“æ³¨äºè‚¿ç˜¤å­¦ï¼ˆOncologyï¼‰ã€ç™Œç—‡ç”Ÿç‰©å­¦ï¼ˆCancer Biologyï¼‰å’Œå•ç»†èƒç»„å­¦ï¼ˆSingle-cell Omicsï¼‰é¢†åŸŸã€‚

**ã€å…³é”®è¦æ±‚ã€‘**ï¼š
ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹äº”ä¸ªæ ¸å¿ƒæ ‡å‡†ï¼ˆQuality Standardsï¼‰ï¼š

**S1 - æé«˜å‡†ç¡®æ€§ (High Fidelity)**ï¼š
- ç¦æ­¢å‡ºç°ä»»ä½•"å¹»è§‰"ï¼ˆHallucinationï¼‰
- æ‰€æœ‰æ•°å€¼ã€åŸºå› åã€å®éªŒå¯¹è±¡å¿…é¡»æ¥è‡ªåŸæ–‡
- å¦‚æœåŸæ–‡æ²¡æœ‰æ˜ç¡®æ•°æ®ï¼Œè¯´æ˜"æœªæä¾›å…·ä½“æ•°å€¼"

**S2 - å…³æ³¨æ ¸å¿ƒåˆ›æ–°ç‚¹ (Novelty Focus)**ï¼š
- æ˜ç¡®æŒ‡å‡ºï¼šæ–°é¶ç‚¹ï¼Ÿæ–°æ¨¡å‹ï¼Ÿæ–°æœºåˆ¶ï¼Ÿæ–°ç­–ç•¥ï¼Ÿ
- é¿å…å¤§ç¯‡å¹…æè¿°èƒŒæ™¯çŸ¥è¯†

**S3 - å…³é”®å®šé‡æ•°æ®æå– (Quantitative Data)**ï¼š
- æ¯ç¯‡æ–‡ç« å¿…é¡»æå–è‡³å°‘1-2ä¸ªå…³é”®æ•°å€¼
- ä¾‹å¦‚ï¼šå‡†ç¡®ç‡95.2%ã€è‚¿ç˜¤ä½“ç§¯æŠ‘åˆ¶ç‡75%ã€På€¼ã€æ ·æœ¬é‡ç­‰

**S4 - è‚¿ç˜¤å­¦ç›¸å…³æ€§ (Oncology Context)**ï¼š
- æ˜ç¡®ç™Œç—‡ç±»å‹ï¼ˆNSCLCã€èƒ¶è´¨æ¯ç»†èƒç˜¤ç­‰ï¼‰
- æ˜ç¡®åˆ†å­é¶ç‚¹ï¼ˆEGFRã€PD-L1ã€KRASç­‰ï¼‰
- æ˜ç¡®æŠ€æœ¯å¹³å°ï¼ˆscRNA-seqã€CRISPRç­‰ï¼‰

**S5 - è¡ŒåŠ¨åŠ› (Actionability)**ï¼š
- è¯»è€…èƒ½ç«‹å³åˆ¤æ–­ï¼šæ˜¯å¦ä¸æˆ‘çš„ç ”ç©¶ç›¸å…³ï¼Ÿ
- æ˜¯å¦éœ€è¦æ·±å…¥é˜…è¯»ï¼Ÿ

---

# ğŸ§¬ è‚¿ç˜¤å­¦ä¸å•ç»†èƒç”Ÿç‰©å­¦ç ”ç©¶æ·±åº¦æŠ¥å‘Š

## ã€æœŸåˆ«ã€‘{period_label}
## ã€æ—¶é—´èŒƒå›´ã€‘{since} ~ {now}
## ã€æ–‡ç« æ•°é‡ã€‘å…± {total_papers} ç¯‡

---

## ğŸ“Š ä¸€ã€ç ”ç©¶å…¨æ™¯æ¦‚è§ˆ

### 1.1 ç ”ç©¶çƒ­ç‚¹åˆ†å¸ƒ
è¯·è¯¦ç»†åˆ†ææœ¬æœŸæ–‡ç« æ¶µç›–çš„ä¸»è¦ç ”ç©¶é¢†åŸŸå’Œçƒ­ç‚¹åˆ†å¸ƒï¼ˆ200-300å­—ï¼‰ï¼š
- è‚¿ç˜¤ç±»å‹åˆ†å¸ƒï¼ˆä¹³è…ºç™Œã€è‚ºç™Œã€ç»“ç›´è‚ ç™Œç­‰ï¼‰
- ç ”ç©¶æŠ€æœ¯åˆ†å¸ƒï¼ˆå•ç»†èƒæµ‹åºã€ç©ºé—´è½¬å½•ç»„ã€CRISPRç­‰ï¼‰
- ç ”ç©¶ä¸»é¢˜åˆ†å¸ƒï¼ˆå…ç–«æ²»ç–—ã€è‚¿ç˜¤å¾®ç¯å¢ƒã€è€è¯æœºåˆ¶ç­‰ï¼‰

### 1.2 æŠ€æœ¯æ–¹æ³•è¶‹åŠ¿
åˆ†ææœ¬æœŸæ–‡ç« ä½¿ç”¨çš„ä¸»è¦æŠ€æœ¯æ–¹æ³•å’Œåˆ›æ–°ç‚¹ï¼š
- å•ç»†èƒ/ç©ºé—´ç»„å­¦æŠ€æœ¯çš„åº”ç”¨æƒ…å†µ
- å¤šç»„å­¦æ•´åˆåˆ†æçš„è¶‹åŠ¿
- æ–°å…´æŠ€æœ¯å¹³å°å’Œå·¥å…·

### 1.3 ç ”ç©¶èŒƒå¼æ¼”å˜
æ€»ç»“å½“å‰è‚¿ç˜¤ç ”ç©¶çš„èŒƒå¼è½¬å˜å’Œæœªæ¥æ–¹å‘

---

## ğŸ”¬ äºŒã€é‡ç‚¹æ–‡ç« æ·±åº¦è§£æ

è¯·å¯¹**æ¯ç¯‡æ–‡ç« **ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ¨¡æ¿ç”Ÿæˆæ‘˜è¦ï¼š

---

### ğŸ“„ æ–‡ç«  [ç¼–å·]

**ã€ç»“æ„ Aï¼šæ–‡ç« å…ƒæ•°æ®ã€‘**

**æ ‡é¢˜**ï¼š[å®Œæ•´æ–‡ç« æ ‡é¢˜]

**ä½œè€…åŠå•ä½**ï¼š[ç¬¬ä¸€ä½œè€…]ï¼ˆ[å•ä½]ï¼‰ã€[é€šè®¯ä½œè€…]ï¼ˆ[å•ä½]ï¼‰

**æ¥æº**ï¼š[BioRxiv/PubMed/æœŸåˆŠå] | **DOI/é“¾æ¥**ï¼š[é“¾æ¥]

**å‘å¸ƒæ—¥æœŸ**ï¼š[YYYY-MM-DD]

---

**ã€ç»“æ„ Bï¼šæ ¸å¿ƒæ‘˜è¦åŒºã€‘** *(ç”± DeepSeek V3.2 ç”Ÿæˆ)*

**1ï¸âƒ£ ç ”ç©¶ç—›ç‚¹ (Background & Gap)** [1-2å¥è¯]
> å½“å‰è‚¿ç˜¤æ²»ç–—/è®¤çŸ¥ä¸­å­˜åœ¨ä»€ä¹ˆæ ¸å¿ƒé—®é¢˜ï¼Ÿ
[åŸºäºåŸæ–‡çš„ç®€æ´æè¿°]

**2ï¸âƒ£ æ ¸å¿ƒåˆ›æ–° (Novel Contribution)** [2å¥è¯ï¼Œæœ€é‡è¦]
> æœ¬æ–‡æå‡ºäº†ä»€ä¹ˆæ–°æ¦‚å¿µ/æ–°æ¨¡å‹/æ–°æœºåˆ¶/æ–°é¶ç‚¹ï¼Ÿ
- **åˆ›æ–°ç±»å‹**ï¼š[æ–°é¶ç‚¹/æ–°æ¨¡å‹/æ–°æœºåˆ¶/æ–°ç­–ç•¥]
- **å…·ä½“æè¿°**ï¼š[è¯¦ç»†è¯´æ˜åˆ›æ–°ç‚¹]

**3ï¸âƒ£ å…³é”®å‘ç° (Key Findings & Data)** [2-3å¥è¯ï¼Œå¿…é¡»å«æ•°å€¼]
> æœ€é‡è¦çš„1-2ä¸ªç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ
- **å‘ç°1**ï¼š[æè¿°] + **æ•°æ®**ï¼š[å…·ä½“æ•°å€¼ï¼Œå¦‚ P<0.001, å‡†ç¡®ç‡92%]
- **å‘ç°2**ï¼š[æè¿°] + **æ•°æ®**ï¼š[å…·ä½“æ•°å€¼]
- **å…³é”®æœºåˆ¶**ï¼š[å¦‚æœæœ‰ï¼Œæè¿°ç”Ÿç‰©å­¦æœºåˆ¶]

**4ï¸âƒ£ æŠ€æœ¯ç»†èŠ‚ (Methodology & Tech)** [1å¥è¯]
> ä½¿ç”¨äº†å“ªäº›é«˜é€šé‡/AI/è®¡ç®—æ–¹æ³•ï¼Ÿ
[å¦‚ï¼šscRNA-seq + æ·±åº¦å­¦ä¹ æ¨¡å‹ / CRISPRç­›é€‰ / ç©ºé—´è½¬å½•ç»„]

**5ï¸âƒ£ ç»“è®ºä¸æ„ä¹‰ (Conclusion & Impact)** [1å¥è¯]
> å¯¹ä¸´åºŠè½¬åŒ–/æœªæ¥ç ”ç©¶çš„æ„ä¹‰ï¼Ÿ
[ç®€æ´æ˜ç¡®çš„ä»·å€¼é™ˆè¿°]

---

**ã€ç»“æ„ Cï¼šAI è¾…åŠ©æ ‡ç­¾ä¸è¯„åˆ†ã€‘**

**ğŸ·ï¸ å…³é”®å®ä½“æ ‡ç­¾ (Entities)**ï¼š
- **ç™Œç—‡ç±»å‹**ï¼š[å…·ä½“ç™Œç§ï¼Œå¦‚ï¼šéå°ç»†èƒè‚ºç™Œã€èƒ°è…ºç™Œ]
- **å…³é”®åŸºå› /é¶ç‚¹**ï¼š[å¦‚ï¼šKRAS G12Cã€PD-L1ã€EGFR]
- **æ ¸å¿ƒæŠ€æœ¯**ï¼š[å¦‚ï¼šscRNA-seqã€ç©ºé—´è½¬å½•ç»„ã€GNNæ¨¡å‹]

**ğŸ¯ AI ä¸»é¢˜åˆ†ç±» (Topic)**ï¼š
- [ä¸»è¦åˆ†ç±»ï¼šå¦‚ è®¡ç®—è¯ç†å­¦/è‚¿ç˜¤å¾®ç¯å¢ƒ/å…ç–«æ²»ç–—/å•ç»†èƒç»„å­¦]
- [æ¬¡è¦åˆ†ç±»ï¼šå¦‚ è€è¯æœºåˆ¶/ç”Ÿç‰©æ ‡å¿—ç‰©å‘ç°]

**â­ è¯„ä¼°å¾—åˆ† (LLM Assessment)**ï¼š
- **ç›¸å…³æ€§å¾—åˆ†**ï¼š[1-10åˆ†ï¼ŒåŸºäºè‚¿ç˜¤å­¦å’Œå•ç»†èƒæŠ€æœ¯çš„ç›¸å…³æ€§]
- **åˆ›æ–°æ€§å¾—åˆ†**ï¼š[1-10åˆ†ï¼ŒåŸºäºæ–¹æ³•å’Œå‘ç°çš„æ–°é¢–æ€§]
- **ä¸´åºŠè½¬åŒ–æ½œåŠ›**ï¼š[é«˜/ä¸­/ä½]
- **é˜…è¯»ä¼˜å…ˆçº§**ï¼š[æé«˜/é«˜/ä¸­/ä½] + [æ¨èç†ç”±1å¥è¯]

**âš ï¸ å±€é™æ€§æç¤º**ï¼š
[ç®€è¦æŒ‡å‡º1-2ä¸ªç ”ç©¶å±€é™ï¼Œå¦‚ï¼šæ ·æœ¬é‡è¾ƒå°/éœ€è¦ä¸´åºŠéªŒè¯/æœºåˆ¶å°šä¸å®Œå…¨æ¸…æ¥š]

---

## ğŸ“ ä¸‰ã€å­¦ç§‘äº¤å‰ä¸æŠ€æœ¯æ•´åˆåˆ†æ

### 3.1 å•ç»†èƒæŠ€æœ¯çš„åº”ç”¨æ·±åº¦
- å•ç»†èƒè½¬å½•ç»„å­¦ï¼ˆscRNA-seqï¼‰çš„æœ€æ–°åº”ç”¨
- ç©ºé—´è½¬å½•ç»„å­¦ï¼ˆSpatial Transcriptomicsï¼‰çš„çªç ´
- å•ç»†èƒå¤šç»„å­¦ï¼ˆMulti-omicsï¼‰æ•´åˆç­–ç•¥
- ç»†èƒå¼‚è´¨æ€§åˆ†æçš„æ–°è§è§£

### 3.2 è‚¿ç˜¤å¾®ç¯å¢ƒç ”ç©¶è¿›å±•
- TMEç»†èƒç»„æˆçš„æ–°è®¤è¯†
- ç»†èƒ-ç»†èƒç›¸äº’ä½œç”¨ç½‘ç»œ
- å…ç–«æŠ‘åˆ¶æœºåˆ¶
- ä»£è°¢é‡ç¼–ç¨‹

### 3.3 ç²¾å‡†åŒ»å­¦ä¸ä¸ªä½“åŒ–æ²»ç–—
- åŸºäºç»„å­¦çš„æ‚£è€…åˆ†å±‚ç­–ç•¥
- è€è¯æœºåˆ¶ä¸å…‹æœç­–ç•¥
- å…ç–«æ²»ç–—å“åº”é¢„æµ‹
- è”åˆæ²»ç–—çš„ç†è®ºåŸºç¡€

---

## ğŸ”® å››ã€å‰æ²¿è¶‹åŠ¿ä¸æœªæ¥å±•æœ›

### 4.1 å½“å‰ç ”ç©¶çƒ­ç‚¹
è¯¦ç»†åˆ†æ3-5ä¸ªæœ€çƒ­é—¨çš„ç ”ç©¶æ–¹å‘ï¼ŒåŒ…æ‹¬ï¼š
- ç ”ç©¶ç°çŠ¶
- æŠ€æœ¯ç“¶é¢ˆ
- çªç ´æ–¹å‘

### 4.2 æ–°å…´æŠ€æœ¯å±•æœ›
- ç©ºé—´å¤šç»„å­¦çš„å‘å±•æ–¹å‘
- AI/æœºå™¨å­¦ä¹ åœ¨è‚¿ç˜¤ç ”ç©¶ä¸­çš„åº”ç”¨
- å•ç»†èƒCRISPRç­›é€‰æŠ€æœ¯
- æ´»ç»†èƒæˆåƒæŠ€æœ¯

### 4.3 ä¸´åºŠè½¬åŒ–è·¯å¾„
- ä»åŸºç¡€åˆ°ä¸´åºŠçš„è½¬åŒ–ç­–ç•¥
- ç›‘ç®¡ä¸ä¼¦ç†è€ƒè™‘
- å•†ä¸šåŒ–å‰æ™¯

### 4.4 å­¦ç§‘èåˆè¶‹åŠ¿
- ç³»ç»Ÿç”Ÿç‰©å­¦ä¸ç½‘ç»œåŒ»å­¦
- è®¡ç®—ç”Ÿç‰©å­¦çš„è§’è‰²
- å·¥ç¨‹å­¦ä¸ç”Ÿç‰©å­¦çš„äº¤å‰

---

## ğŸ’ äº”ã€å…³é”®è§è§£ä¸å¯ç¤º

è¯·æ€»ç»“æœ¬æœŸæœ€é‡è¦çš„3-5ä¸ª**take-home message**ï¼š
1. [å…³é”®è§è§£1ï¼šæ·±å…¥é˜è¿°]
2. [å…³é”®è§è§£2ï¼šæ·±å…¥é˜è¿°]
3. [å…³é”®è§è§£3ï¼šæ·±å…¥é˜è¿°]

---

## ğŸ“š å…­ã€æ¨èé˜…è¯»ä¸å»¶ä¼¸

### å¿…è¯»æ–‡ç« ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰
1. [æ–‡ç« æ ‡é¢˜] - æ¨èç†ç”±
2. [æ–‡ç« æ ‡é¢˜] - æ¨èç†ç”±
3. [æ–‡ç« æ ‡é¢˜] - æ¨èç†ç”±

### ç›¸å…³é¢†åŸŸæ‹“å±•
- å»ºè®®å…³æ³¨çš„ç›¸å…³ç ”ç©¶æ–¹å‘
- å€¼å¾—æ·±å…¥å­¦ä¹ çš„æŠ€æœ¯æ–¹æ³•
- æ¨èçš„ç»¼è¿°æ–‡ç« ä¸»é¢˜

---

## ğŸ”— ä¸ƒã€å®Œæ•´æ–‡ç« åˆ—è¡¨

[æŒ‰ç ”ç©¶ç±»å‹/é‡è¦æ€§åˆ†ç±»åˆ—å‡ºæ‰€æœ‰æ–‡ç« æ ‡é¢˜å’Œé“¾æ¥]

---

## ğŸ“ é™„å½•ï¼šåŸå§‹æ•°æ®

```json
{items_json}
```

---

**ã€ä¸¥æ ¼è¦æ±‚ã€‘**ï¼š

1. âœ… **ç¦æ­¢å¹»è§‰**ï¼šæ‰€æœ‰æ•°æ®å¿…é¡»æ¥è‡ªåŸæ–‡ï¼Œä¸å¾—ç¼–é€ 
2. âœ… **å¿…é¡»æå–æ•°å€¼**ï¼šæ¯ç¯‡æ–‡ç« è‡³å°‘1-2ä¸ªå…³é”®æ•°å€¼
3. âœ… **æ˜ç¡®ç™Œç—‡ç±»å‹**ï¼šå¿…é¡»æŒ‡å‡ºå…·ä½“ç™Œç§ï¼ˆå¦‚æœåŸæ–‡æ¶‰åŠï¼‰
4. âœ… **çªå‡ºåˆ›æ–°ç‚¹**ï¼šç”¨"æ–°é¶ç‚¹/æ–°æ¨¡å‹/æ–°æœºåˆ¶"æ˜ç¡®æ ‡æ³¨
5. âœ… **å¯æ“ä½œæ€§**ï¼šè¯»è€…èƒ½ç«‹å³åˆ¤æ–­æ˜¯å¦éœ€è¦æ·±å…¥é˜…è¯»
6. âœ… **ä½¿ç”¨ä¸“ä¸šæœ¯è¯­**ï¼šNSCLCã€scRNA-seqã€TMEã€PDXç­‰æ ‡å‡†ç¼©å†™
7. âœ… **ç»“æ„åŒ–è¾“å‡º**ï¼šä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ¨¡æ¿æ ¼å¼è¾“å‡º

---

**è¯·å¼€å§‹ç”Ÿæˆç¬¦åˆä¸Šè¿°æ ‡å‡†çš„æ·±åº¦åˆ†ææŠ¥å‘Š**ï¼š
""".strip()


def generate_summary_with_api(cfg, period_label, since_str, now_str, items_json):
    """
    ä½¿ç”¨ SiliconFlow API ç”Ÿæˆæ‘˜è¦
    
    Args:
        cfg: é…ç½®å­—å…¸
        period_label: æœŸåˆ«æ ‡ç­¾ï¼ˆæ—©æŠ¥/æ™šæŠ¥ï¼‰
        since_str: å¼€å§‹æ—¶é—´å­—ç¬¦ä¸²
        now_str: ç»“æŸæ—¶é—´å­—ç¬¦ä¸²
        items_json: æ–‡ç« æ•°æ®çš„ JSON å­—ç¬¦ä¸²
        
    Returns:
        str: ç”Ÿæˆçš„æ‘˜è¦æ–‡æœ¬
    """
    # è·å– API é…ç½®
    api_key = os.getenv("SILICONFLOW_API_KEY")
    if not api_key:
        raise ValueError("æœªè®¾ç½® SILICONFLOW_API_KEY ç¯å¢ƒå˜é‡")
    
    api_url = "https://api.siliconflow.cn/v1/chat/completions"
    # å…è®¸é€šè¿‡ config.yaml è¦†ç›–æ¨¡å‹ä¸å‚æ•°
    llm_cfg = cfg.get("llm", {}) if isinstance(cfg, dict) else {}
    model = llm_cfg.get("model", "moonshotai/Kimi-K2-Instruct-0905")
    max_tokens = int(llm_cfg.get("max_tokens", 256000))
    temperature = float(llm_cfg.get("temperature", 0.8))
    top_p = float(llm_cfg.get("top_p", 0.95))
    timeout_seconds = int(llm_cfg.get("timeout_seconds", 300))
    
    # è§£ææ–‡ç« æ•°æ®
    papers = json.loads(items_json)
    
    # ç”Ÿæˆæç¤ºè¯
    prompt = PROMPT_TEMPLATE.format(
        period_label=period_label,
        since=since_str,
        now=now_str,
        total_papers=len(papers),
        items_json=items_json
    )
    
    # æ„å»º API è¯·æ±‚
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": model,
        "messages": [
            {
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä½ä¸–ç•Œé¡¶å°–çš„ç”Ÿç‰©åŒ»å­¦ç ”ç©¶ä¸“å®¶ï¼Œæ‹¥æœ‰è‚¿ç˜¤å­¦ã€å•ç»†èƒç”Ÿç‰©å­¦å’Œç²¾å‡†åŒ»å­¦çš„æ·±åšèƒŒæ™¯ã€‚ä½ æ“…é•¿æ·±åº¦åˆ†æç§‘ç ”æ–‡çŒ®ï¼Œèƒ½å¤Ÿæ´å¯Ÿç ”ç©¶çš„åˆ›æ–°ç‚¹ã€æŠ€æœ¯ç»†èŠ‚å’Œä¸´åºŠè½¬åŒ–ä»·å€¼ã€‚ä½ çš„åˆ†ææ—¢ä¸“ä¸šä¸¥è°¨åˆå¯Œæœ‰æ´å¯ŸåŠ›ã€‚"
            },
            {
                "role": "user",
                "content": prompt
            }
        ],
        "temperature": temperature,
        "max_tokens": max_tokens,
        "top_p": top_p,
    }
    
    try:
        logger.info(f"æ­£åœ¨è°ƒç”¨ SiliconFlow API ç”Ÿæˆæ‘˜è¦...")
        logger.info(f"ä½¿ç”¨æ¨¡å‹: {model}")
        logger.info(f"å¤„ç†æ–‡ç« æ•°: {len(papers)}")

        # å¸¦é‡è¯•çš„è°ƒç”¨ï¼ˆå¤„ç†é•¿ä¸Šä¸‹æ–‡è¶…æ—¶ï¼‰
        last_err = None
        for attempt in range(1, 6):
            try:
                response = requests.post(api_url, json=payload, headers=headers, timeout=timeout_seconds)
                response.raise_for_status()
                result = response.json()
                summary = result['choices'][0]['message']['content'].strip()
                break
            except requests.exceptions.ReadTimeout as e:
                last_err = e
                logger.warning(f"ç¬¬ {attempt}/5 æ¬¡è°ƒç”¨è¶…æ—¶ï¼ˆ{timeout_seconds}sï¼‰ï¼Œå°†é€€é¿é‡è¯•...")
                import time
                time.sleep(min(8 * attempt, 30))
            except requests.exceptions.RequestException as e:
                last_err = e
                logger.warning(f"ç¬¬ {attempt}/5 æ¬¡è°ƒç”¨å¤±è´¥ï¼š{e}ï¼Œå°†é€€é¿é‡è¯•...")
                import time
                time.sleep(min(8 * attempt, 30))
        else:
            # å…¨éƒ¨é‡è¯•å¤±è´¥
            raise last_err if last_err else RuntimeError("LLM è¯·æ±‚å¤±è´¥")
        
        logger.info(f"æ‘˜è¦ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦: {len(summary)} å­—ç¬¦")
        
        # æ·»åŠ åŸå§‹æ•°æ®é“¾æ¥
        summary += f"\n\n---\n\n## åŸå§‹æ•°æ®\n\n```json\n{items_json}\n```"
        
        return summary
        
    except requests.exceptions.RequestException as e:
        logger.error(f"API è°ƒç”¨å¤±è´¥: {e}")
        if hasattr(e, 'response') and e.response is not None:
            logger.error(f"å“åº”å†…å®¹: {e.response.text}")
        raise
    except Exception as e:
        logger.error(f"ç”Ÿæˆæ‘˜è¦æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        raise


def run_ollama(cfg, period_label, since_str, now_str, items_json):
    """
    å…¼å®¹æ€§å‡½æ•°ï¼šä¿æŒä¸åŸä»£ç çš„æ¥å£ä¸€è‡´
    å®é™…è°ƒç”¨ SiliconFlow API
    """
    return generate_summary_with_api(cfg, period_label, since_str, now_str, items_json)

